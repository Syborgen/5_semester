<HTML>
<HEAD>
<TITLE>Аппаратные прерывания</TITLE>
</HEAD>
<BODY>

<CENTER>
<H1>Аппаратные прерывания</H1>
<FONT SIZE="3">
</CENTER>

<UL>
 <LI><A HREF="03/8086.html">Аппаратные прерывания Intel 8086</A>
 <LI><A HREF="03/i486pr.html">Аппаратные прерывания Intel i486</A>
 <LI><A HREF="#ВПП">Внутренние прерывания процессора и сопроцессора</A>
 <LI><A HREF="#not_mask">Немаскируемые внешние прерывания</A>
 <LI><A HREF="#mask">Маскируемые внешние прерывания</A>
</UL>
<HR SIZE="4">
<BLOCKQUOTE>
	<P>
<HR>
<strong>Прерывание</strong>- это изменение текущей последовательности команд. 

<HR>

</BLOCKQUOTE>
  Аппаратные прерывания  обеспечивают  реакцию  процессора на  события, происходящиее асинхронно  по  отношению к исполняемому программному коду. Процесоры 
семейства х86 и поддерживают таблицу, содержащую определения до 256 процедур 
обслуживания.
  Условия возникновения прерываний проверяются процессором на границе инструкций. 
Это означает, что  все шинные операции текущей инструкции будут за
вершены до начала обработки прерывания. При обработке прерывания процессор 
сохраняет в стеке слово состояния (регистры флагов, кодового сегмента и указатель  
следующей инструкции), сбрасывает  флаг разрешения прерываний IF и 
вызывает процедуру обслуживания, точка входа в которую описана таблице прерываний, 
хранящейся в ОЗУ. Процедура обработки завершается инструкцией IRET,
по  которой из стека  восстанавливаются автоматически сохранённые регистры 
(в регистре флагов прерывания разрешены)  и процессор  наинает  выполнение 
инструкции, следующей за той, после которой  исполнялось прерывание. Конечно 
программно во время обслуживания прерывания возможно умышленное или случайное 
изменение указателя или содержимого стека, и тогда инструкция  IRET
"отправит" процессор по другому адресу, в результате чего  компьютер может 
и зависнуть. Прерывания могут быть и вложенными, если процедура  обслуживания 
установит флаг IF. Тогда возникает опасность  переполнения  стека, поскольку 
каждое "вложение" будет использовать его для своих целей. Переполнение стека 
может также являться прииной зависаний. Длинные процедуры  процедуры  обработки 
со сброшенным флагом IF могут  привести к потере системого 
времени, поскольку часы операционной системы используют аппаратные прерывания 
от таймера. Процедура  обслуживания  для  каждого источника аппаратных 
прерываний  должна быть  написана весьма осмотрительно и учитывать ньюансы 
работы остальных подсистем. <BR>
<P>
<H2><A NAME="ВПП">Внутренние прерывания процессора</A></H2>
<P>
Внутренние прерывания процессора (исключения) генерируются при возникнове
нии  особых условий выполнения текущей инструкции. В большинстве своём они 
не столько асинхронны, сколько неожиданы для исполнения программного кода.  
Под эти прерывания фирмой Intel были зарезервированы первые 32 вектора таблицы 
прерываний, однако в IBM PC/XT/AT многие из них пересекаются с внешними и 
программными прерываниями, что порождает некоторые проблемы.<A HREF="literatura.html">[2]</A><BR>
 Внутренние прерывания микропроцессора 8086/8088 вырабатываются процессором 
по особым условиям:<BR>
 <UL>
 <LI TYPE=DISC> прерывание типа 0 вырабатывается в случае переполнения 
                    при операциии деления на 0; <BR>
 <LI TYPE=DISC> прерывание типа 1 вырабатывается после выполнения каждой
                    команды при установленном флаге трассировки IF; <BR>
 <LI TYPE=DISC> прерывание типа 4 вырабатывается по команде INTO(Interrupt
                    Overflow), если установлен флаг переполнения OF. <BR>
</UL>
<P>
<H2><A NAME="not_mask">Немаскируемые внешние прерывания</A></H2>
<P>
  Немаскируемые прерывания обрабатываются процессором независимо от состояния флага 
разрешения прерывания IF. К ним относятс прерывания, приходящие по линии NMI, а
для процессоров, поддерживающих режим системного управления, ещё и по линии SMI#.<BR><p>
  Сигнал на линию NMI приходит от схем контроля паритета памяти, от линии IOCHK 
шины ISA или SERR# шины PCI. В машинах класса AT сигнал NMI блокируется до входа 
процессора установкой в "1" бита 7 порта 070h, отдельные источники - битами 2, 3
порта 061h. Индентифицировать источник NMI позволяют биты 6, 7 регистра 061h.<BR><p>
  В XT NMI вызывается ещё и математическим сопроцессором при возникновении 
исключеня. Запретить NMI позволяет обнуление бита 7 порта 0А0h; отдельные источники
блокируются битами 4, 5 регистра 061h; индентифицируют источники биты 6, 7 регистра
062h.<A HREF="literatura.html">[2]</A><BR><p>
 Если во время обработки немаскируемого прерывания снова появляется сигнал NMI, то 
вложенного прерывания не будет - повторный вызов обработчика NMI возможен только 
после исполнения инструкции IRET.<BR><p>
  Прерывание SMI возникает от схем чипсета, учавствующих в управлении энергопотреблением.
Это прерывание имеет наивысший приоритет и обслуживается несколько иначе, чем 
"классические" прерывания. Здесь процессор не выполняет вызов процедуры, описаной
в таблице прерываний, а переходит в режим SMM. Первым делом в памяти SMRAM (а не в стеке!)
автоматически сохраняется контекст процессора, после чего начинается исполнение кода
по определённому адресу в памяти SMRAM. В режиме SMM обычные прерывания (в том числе 
и немаскируемые) запрещены, так что процессор не нуждается в обычной памяти, которая
для него недоступна. При необходимости обработка прерываний может быть и разрешена,
но это требует некоторых действий с таблицей прерываний. Выход из режима SMM
происходит по выполнении инструкции RSM, завершающей процедуру обработки SMI. 
По этой инструкции автоматически восстанавливается сохранный (или умышленно 
модифицированный) контекст процессора, процессор входит в обычное адресное 
пространство памяти (снимается сигнал SMIACT#) и переходит к выполнению прерваной
программы. В отличие от обычных прерываний, по окончании обслуживания которых 
процессор переходит к исполнению инструкции, следующей за исполненной до начала 
обработки прерывания, расширенные средства SMM предполагают возможность рестарта 
некоторых инструкций. Рестарт (повторное исполнение) возможен для инструкции 
останова (HALT) и инструкций ввода/вывода. Воэможность рестарта инструкции 
ввода/вывода используют, например, когда прикладная программа (или системный 
драйвер) пытается обратиться операцией ввода/вывода к периферийному устройству, 
находящемуся в "спящем" режиме. Системная логика в этом случае должна 
выработать сигнал SMI# раньше сигнала готовности RDY#, завершающего шинный цикл 
рестартуемой инструкции ввода/вывода. Обработчик SMI "разбудит" устройство, после 
чего операция ввода/вывода рестартует и прикладное ПО (или драйвер) "не заметит", 
что устройство пребывало в спячке. Таким образом управление потреблением может 
быть организовано на уровне BIOS способом, совершенно прозрачным для программного 
обеспечения (в том числе и ОС).
<P>
<H2><A NAME="mask">Маскируемые внешние прерывания</A></H2>
<P>
Ниже рассмотрена <a href="#1411">таблица аппаратных прерываний</a>
<P>
  Обработка маскируемых прерываний может запрещаться инструкцией DI и разрешаться - 
EI (или другим способом воздействия на флаг процессора IF). Эти прерывания обслуживания
контроллером, программно-овместимым с микросхемой 8259А, входящей ещё в комплект
поддержки процессоров 8086/88. Такой контроллер имеет 8 входов запросов прерывания 
IRQx от внешних источников и выход запроса INTR, по которому запрос поступает на 
одноименный вход процессора. При обрабоке запроса INTR процессор формирует шинный 
цикл подтверждения прерывания INTA, в котором контроллер передаёт по шине данных 
8-битный вектор прерывания. Этот вектор и является номером, по которому ссылка на 
процедуру обработки прерывания хранится в таблице прерываний. Исторически сложилось 
так, что контроллер 8259А требует двух шинных циклов INTA, из которых процессоры 
80х86 для передачи вектора используют только второй (первый цикл использовался для 
подачи кода инструкции прерывания ещё в процессоре 8080, и циклов было даже три). 
В дань совместимости и современные процессоры выполняют этот лишний цикл системной 
шины.<A HREF="literatura.html">[2]</A><br><p>
  Контроллеры 8259А допускают каскадное соединение:<I> ведущий </I>(Master) контроллер 
подключается ко входу запроса прерываний процессора, а ко входам этого котроллера могут 
подключаться<I> ведомые </I>(Slave) контроллеры. Таким образом можно увеличить число 
линий источников прерываний до 8х8=64. Каскадирование применяется в машинах класса AT, 
где используется два контроллера. Ведущий контроллер 8259A#1 обслуживает запросы 0, 1, 
3-7. К его входу 2подключен ведомый контроллер 8259A#2, который обслуживает запросы 8-15. 
При этом используется вложенность приоритетов - запросы 8-15 со своим рядом убывающих 
приоритетов вклиниваются между запросами 1 и 3 ведущего контроллера, приоритеты запросов 
которого также убывают с ростом номера. В XT каскадирование не применялось и один 8259 
обслуживал все 8 линий запросов.<A HREF="literatura.html">[2]</A><BR><p>
  На входы контроллеров прерываний поступают запросы от системных устройств (клавиатура, 
системный таймер, CMOS-таймер, сопроцессор) и от плат расширения. Традиционно все линии 
запросов, не занятые перечисленными системными устройствами, присутствуют на слотах шины 
ISA/EISA. Эти линии обозначаются как IRQx и имеют общепринятые предназначения, 
приведенные в табл. 1. В таблиц отражены и приоритеты прерываний - запросы расположены 
в порядке их убывания. Номера векторов, соответствующих линиям запросов контроллеров, 
система приоритетов и некоторые другие параметры задаются программно при инициализации 
контроллеров. Эти основные настройки сохраняются традиционными для обеспечения 
совместимости с программным обеспечением.<BR><p>
<TABLE BORDER="1"
       WIDTH="55%"
       CELLPADDING="1"
       CELLSPACING="1"
>
<CAPTION><a name="1411"> Таблица 1411. Аппаратные прерывания </a></CAPTION>
    <TR>
     <TH> Имя (номер) </TH>
     <TH> Вектор   </TH>
     <TH> Описание   </TH>
    <TR>
     <TD ALIGN=center VALIGN=center> NMI </TH>
     <TD> 02h </TD>                 
     <TD> Контроль канала, паритет (в XT - сопроцессор) </TD> 
    <TR>
     <TD> 0 </TD>
     <TD> 09h  </TD>
     <TD> Таймер (канал 0 8253/8254 </TD>
    <TR>
     <TD> IRQ2 </TD>
     <TD>  0Ah </TD>
     <TD>  XT - резерв, AT - каскад IRQ8-IRQ15  </TD>  
    <TR>
     <TD> 8 </TD>
     <TD> 07h  </TD>
     <TD> CMOS RCT - часы реального времени </TD>  
   <TR>
     <TD> IRQ9 </TD>
     <TD> 71h </TD>
     <TD> Резерв </TD>  
   <TR>
     <TD> IRQ10</TD>
     <TD> 72h </TD>
     <TD> Резерв </TD>  
   <TR>
     <TD> IRQ11</TD>
     <TD> 73h </TD>
     <TD> Резерв </TD>  
   <TR>
     <TD> IRQ12 </TD>
     <TD> 74h </TD>
     <TD> PS/2 - Mouse (резерв) </TD>  
   <TR>
     <TD> 13 </TD>
     <TD> 75h </TD>
     <TD> Математический сопроцессор </TD>
   <TR>
     <TD> IRQ14 </TD>
     <TD> 76h </TD>
     <TD> HDC - контроллер НЖМД </TD>    
   <TR>
     <TD> IRQ15 </TD>
     <TD> 77h </TD>
     <TD> PS/2 - Mouse   
   <TR>
     <TD> IRQ3 </TD>
     <TD> 0Bh </TD>
     <TD> COM2, COM4 </TD>  
   <TR>
     <TD> IRQ4 </TD>
     <TD> 0Ch </TD>
     <TD> COM1, COM3 </TD>
   <TR>
     <TD> IRQ5 </TD>
     <TD> 0Dh </TD>
     <TD> XT - HDC, AT - LPT2, Sound (резерв) </TD>    
   <TR>
     <TD> IRQ6 </TD>
     <TD> 0Eh </TD>
     <TD> FDC - контроллер НГМД </TD>  
   <TR>
     <TD> IRQ7 </TD>
     <TD> 0Fh </TD>
     <TD> LPT1 - принтер </TD>  
   </TABLE><BR>
  Назначения номеров прерываний выполняются с двух сторон: во-первых, адаптер, 
нуждающийся в использовании прерываний, должен быть сконигурирован на использование 
конкретной линии шины (джамперами или программно). Во-вторых, программное 
обеспечение, поддерживающее данный адаптер, должно быть проинформировано о номере 
используемого вектора. Поскольку линии запросов прерываний в компьютере, насыщеном 
дополнительными адаптерами, являются самым дефицитным рессурсом, возникает желание 
использоватьэти линии разделяемо между несколькими устройствами. Тогда обработчик 
прерывания одного устройства, определив, что источник - не его, вызывал бы источник 
другого устройства, конкурирующего по другой линии запроса. Однако в шине ISA 
прерывание вырабатывается по<I> положительному перепаду сигнала </I>на линии 
запроса - разработчики XT сэкономили целую микросхему ТТЛ (своеобразный "плевок 
в вечность"). Это плохо по двум причинам: во-первых, как известно из общей цифровой 
схемотехники, такой способ подачи сигнала имеет меньшую помехозащищённость, 
чем срабатывание по отрицательному перепаду. Если кто обращал внимание на сообщение 
"Spurious Interrupt was detected on kontroller...", иногда появляющегося на 
консоли сервера NetWare, то ониотносятся именно к обнаружению этих помех. В 
операционных системах, неактивно использующих прерывания (а к ним, в первую 
очередь, относится MS-DOS), эти явления незаметны и обычными тестами (PC Check, 
ChekIt) не выявляются. Во-вторых, такой способ подачи сигнала отрезает путь к 
нормальному разделяемому использованию линий, для которого полностью пригоден 
способ подачи сигнала по низкому уровню. Поскольку традиционный контроллер 
позволяет задавать чувствительность -<I> уровень </I>(Level) или<I> перепад </I>
(Edge) - только для всех входов одновременно, в общем случае разделяемые 
прерывания на шине ISA вместе с корректной работой системных устройств 
использоваться не могут. Однако некорректные чипсеты системных плат, реализующие 
и функции контроллеров прерываний, допускают индивидуальное управление 
чувствительностью каждого входа. Тогда при соответствующих возможностях 
конфигурируемости BIOS Setup и применяемыхадаптеров раздляемые прерывания 
технически реализуемы.<BR><p>
  При чувствительности к уровню сигнал запроса аппаратного прерывания IRQx 
должен удерживаться схемой, его генерирующей, по крайней мере до цикла подтверждения 
прерывания процессором. В противном случае источник прерывания корректно 
индентифицирован не будет. Обычно адаптеры строят так, что сигнал запроса 
сбрасывается при обращении программы обслуживания прерывания к соответствующим 
регистрам адаптера.<BR><p>
  Для запросов прерывания с шины PCI используются 4 линии запросов прерывания, 
которые обозначают как INTR A, B, C, D. Эти линии работают по низкому уровню, 
что даёт возможность их разделяемого использования. Линии циклически сдвигаются 
в слотах (рис. 1) и независимо коммутируются на доступные линии IRQx с помощью 
конфигурационных регистров чипсета. Линии IRQx, используемые шиной PCI, становятся 
недоступными для шины ISA. "Делёжку" линий между шинами, а также управление 
чувствительностью отдельных линий выполняют настройки опций BIOS Setup, а также 
система PnP. В опциях настройки "ISA" или "Legacy" подразумевают использование 
линий IRQx традиционными адаптерами шины ISA (стратегическое распределение), 
а "PCI/PnP" - использование адаптерами шины PCI или адаптерами PnP для шины ISA 
(динамическое распределение).<br><p>
  Как уже говорилось, в AT используются контроллеры прерываний, совместимые с 
8259A. На современных системных платах их функции возлагаются на чипсет, который 
может иметь и более гибкие возможности управления. В любом случае, в операционном 
режиме сохраняется программная совместимость с 8259A, а инициализация может и 
отличаться, но ей занимается POST, который "знает" особенности системной платы. 
В симметричных мультипроцессорных системах аппаратные прерывания работают сложнее, 
поскольку их могут обслуживать различные процессоры. Для реализации системы 
прерываний процессоры Pentium, Pentium Pro и Pentium II имеют встроенный контроллер 
прерываний APIC (Advanced Programmable Interruption Controller). Внутренние 
контроллеры процессоров связаны между собой по шине APIC, к которой подключена и 
"ответная" часть чипсета, преобразующая запросы аппаратных прерываний в сигналы 
протокола APIC. В операционном режиме такая связка также совместима с 8259A.
<BR><P>
</CENTER>
</BODY>
</HTML>