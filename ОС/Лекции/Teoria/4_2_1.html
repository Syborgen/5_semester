<html>
<head>
<title>Логическая структура диска в MS-DOS</title>
</head>

<body>

<center>
<h1>Логическая структура диска в MS-DOS</h1>
</center>

<p>Вы, конечно, знаете, что файловая система MS-DOS
имеет древовидную структуру. В корневом каталоге
располагаются 32-байтовые элементы, которые
содержат информацию о файлах и других каталогах.
Для чтения корневого каталога необходимо
определить его расположение и размер. </p>

<h3><font SIZE="4" COLOR="#008000">Расположение и размер
корневого каталога</font></h3>

<p>Корневой каталог находится сразу за последней
копией FAT . Количество секторов, занимаемых одной
копией FAT, находится в блоке параметров BIOS в
загрузочном секторе (поле fatsize), а количество
копий FAT - в поле fatcnt блока BPB . Следовательно,
перед корневым каталогом находится один
загрузочный сектор и fatcnt&nbsp;*&nbsp;fatsize секторов
таблицы размещения файлов FAT. </p>

<p>Размер корневого каталога можно определить
исходя из значения поля rootsize. При форматировании
диска в это поле записывается максимальное
количество файлов и каталогов, которые могут
находиться в корневом каталоге. Для каждого
элемента в каталоге отводится 32 байта, поэтому
корневой каталог имеет длину 32&nbsp;*&nbsp;rootsize байт. </p>

<p>Корневой каталог занимает непрерывную область
фиксированного размера. Размер корневого
каталога задается при форматировании и
определяет максимальное количество файлов и
каталогов, которые могут быть в нем описаны. </p>

<p>Для определения количества секторов,
занимаемых корневым каталогом, можно
воспользоваться следующей формулой: </p>

<pre>
<font COLOR="#000080">RootSecs = sectsize&nbsp;/&nbsp;(32&nbsp;*&nbsp;rootsize)</font>
</pre>

<p>В этой формуле sectsize - размер сектора в байтах, он
может быть получен из соответствующего поля
загрузочного сектора. </p>

<h3><font SIZE="4" COLOR="#008000">Область файлов и подкаталогов</font></h3>

<p>На рис. 2.3 изображены все области логического
диска. Такую структуру имеют логические диски ,
расположенные в разделах жестких дисков, а также
дискеты. </p>

<p align="center"><img src="04/IMG00006.GIF" alt="IMG00006.GIF (6441 bytes)" WIDTH="366"
HEIGHT="200"> </p>

<p align="center"><i>Рис. 2.3. Структура логического диска
MS-DOS</i> </p>

<p>Вслед за корневым каталогом на логическом
диске находится область файлов и подкаталогов
корневого каталога . </p>

<p>Область данных разбита на кластеры, причем
нумерация кластеров начинается с числа 2.
Кластеру с номером 2 соответствуют первые
секторы области данных. </p>

<p>Теперь мы можем привести формулу, которая
позволит нам связать номер кластера с номерами
секторов, занимаемых им на логическом диске: </p>

<pre>
<font COLOR="#000080">SectNu = DataStart + ((ClustNu - 2) * clustsize)</font>
</pre>

<p>В этой формуле использованы следующие
обозначения:<br>
</p>

<table>
  <tr>
    <td WIDTH="73">SectNu</td>
    <td WIDTH="369">номер первого сектора, распределенного
    кластеру с номером ClustNu; </td>
  </tr>
  <tr>
    <td WIDTH="73">DataStart</td>
    <td WIDTH="369">начало области данных, вычисляется по
    формуле:<p>ressecs + (fatsize * fatcnt) + (32 * rootsize/ sectsize); </td>
  </tr>
  <tr>
    <td WIDTH="73">ClustNu</td>
    <td WIDTH="369">номер кластера, для которого необходимо
    определить номер первого сектора; </td>
  </tr>
  <tr>
    <td WIDTH="73">clustsize</td>
    <td WIDTH="369">количество секторов, занимаемых
    кластером; находится в блоке параметров BIOS. </td>
  </tr>
</table>

<h3><font SIZE="4" COLOR="#008000">Дескрипторы файлов </font></h3>

<p>Как мы уже говорили, любой каталог содержит
32-байтовые элементы - дескрипторы, описывающие
файлы и другие каталоги. Приведем формат
дескриптора:<br>
</p>

<table BORDER="1">
  <tr>
    <td WIDTH="83"><strong>Смещение</strong></td>
    <td WIDTH="66"><strong>Размер</strong></td>
    <td WIDTH="296"><strong>Содержимое </strong></td>
  </tr>
  <tr>
    <td WIDTH="83">0</td>
    <td WIDTH="66">8</td>
    <td WIDTH="296">Имя файла или каталога, выровненное на
    левую границу и дополненное пробелами </td>
  </tr>
  <tr>
    <td WIDTH="83">8</td>
    <td WIDTH="66">3</td>
    <td WIDTH="296">Расширение имени файла, выровненное на
    левую границу и дополненное пробелами </td>
  </tr>
  <tr>
    <td WIDTH="83">11</td>
    <td WIDTH="66">1</td>
    <td WIDTH="296">Байт атрибутов файла </td>
  </tr>
  <tr>
    <td WIDTH="83">12</td>
    <td WIDTH="66">10</td>
    <td WIDTH="296">Зарезервировано </td>
  </tr>
  <tr>
    <td WIDTH="83">22</td>
    <td WIDTH="66">2</td>
    <td WIDTH="296">Время создания файла или время его
    последней модификации </td>
  </tr>
  <tr>
    <td WIDTH="83">24</td>
    <td WIDTH="66">2</td>
    <td WIDTH="296">Дата создания файла или дата его
    последней модификации </td>
  </tr>
  <tr>
    <td WIDTH="83">26</td>
    <td WIDTH="66">2</td>
    <td WIDTH="296">Номер первого кластера, распределенного
    файлу </td>
  </tr>
  <tr>
    <td WIDTH="83">28</td>
    <td WIDTH="66">4</td>
    <td WIDTH="296">Размер файла в байтах </td>
  </tr>
</table>

<p>В любом каталоге, кроме корневого, два первых
дескриптора имеют специальное назначение.
Первый дескриптор содержит в поле имени строку: </p>

<pre><font COLOR="#000080">&quot;.       &quot;</font></pre>

<p>Этот дескриптор указывает на содержащий его
каталог. То есть каталог имеет ссылку сам на себя.
</p>

<p>Второй специальный дескриптор содержит в поле
имени строку: </p>

<pre><font COLOR="#000080">&quot;..      &quot;</font></pre>

<p>Этот дескриптор указывает на каталог более
высокого уровня. </p>

<p>Если в поле номера первого занимаемого
кластера для дескриптора с именем &quot;.. &quot;
находится нулевое значение, это означает, что
данный каталог содержится в корневом каталоге. </p>

<p>Таким образом, в древовидной структуре
каталогов имеются ссылки как в прямом, так и в
обратном направлении. Эти ссылки можно
использовать для проверки сохранности структуры
каталогов файловой системы. </p>

<h3><font SIZE="4" COLOR="#008000">Атрибуты файлов </font></h3>

<p>Байт атрибутов является принадлежностью
каждого файла. Биты этого байта имеют следующие
значения:<br>
</p>

<table BORDER="1">
  <tr>
    <td WIDTH="48"><strong>Бит</strong></td>
    <td WIDTH="397"><strong>Описание</strong></td>
  </tr>
  <tr>
    <td WIDTH="48">0</td>
    <td WIDTH="397">Файл предназначен только для чтения.В
    этот файл нельзя писать и его нельзя стирать </td>
  </tr>
  <tr>
    <td WIDTH="48">1</td>
    <td WIDTH="397">Скрытый файл.Этот файл не будет
    появляться в списке файлов, создаваемом командой
    DIR </td>
  </tr>
  <tr>
    <td WIDTH="48">2</td>
    <td WIDTH="397">Системный файл. Этот бит обычно
    установлен в файлах, являющихся составной частью
    операционной системы </td>
  </tr>
  <tr>
    <td WIDTH="48">3</td>
    <td WIDTH="397">Данный дескриптор описывает метку
    диска.Для этого дескриптора поле имени файла и
    поле расширения имени файла должны
    рассматриваться как одно поле длиной 11 байт. Это
    поле содержит метку диска </td>
  </tr>
  <tr>
    <td WIDTH="48">4</td>
    <td WIDTH="397">Дескриптор описывает файл, являющийся
    подкаталогом данного каталога </td>
  </tr>
  <tr>
    <td WIDTH="48">5</td>
    <td WIDTH="397">Флаг архивации.Если этот бит установлен
    в 1, то данный файл не был выгружен утилитой
    архивации </td>
  </tr>
  <tr>
    <td WIDTH="48">6-7</td>
    <td WIDTH="397">Зарезервированы</td>
  </tr>
</table>

<p>Обычно файлы имеют следующие атрибуты:<br>
</p>

<table BORDER="1">
  <tr>
    <td WIDTH="83"><strong>Атрибут</strong></td>
    <td WIDTH="362"><strong>Описание</strong></td>
  </tr>
  <tr>
    <td WIDTH="83">0</td>
    <td WIDTH="362">Обычные файлы (тексты программ,
    загрузочные модули, пакетные файлы) </td>
  </tr>
  <tr>
    <td WIDTH="83">7</td>
    <td WIDTH="362">Только читаемые, скрытые, системные
    файлы. Такая комбинация битов байта атрибутов
    используется для файлов операционной системы
    io.sys , msdos.sys </td>
  </tr>
  <tr>
    <td WIDTH="83">8</td>
    <td WIDTH="362">Метка тома. Дескриптор метки тома может
    находиться только в корневом каталоге
    логического диска </td>
  </tr>
  <tr>
    <td WIDTH="83">10h</td>
    <td WIDTH="362">Дескриптор, описывающий каталог </td>
  </tr>
  <tr>
    <td WIDTH="83">20h</td>
    <td WIDTH="362">Обычный файл, который не был выгружен
    программами backup.exe или xcopy.exe </td>
  </tr>
</table>

<h3><font SIZE="4" COLOR="#008000">Дескрипторы удаленных файлов</font></h3>

<p>При удалении файла первый байт его имени
заменяется на байт E5h (символ &quot;х&quot;). Все
кластеры, распределенные файлу, отмечаются в FAT
как свободные. Если вы только что удалили файл,
его еще можно восстановить, так как в дескрипторе
сохранились все поля, кроме первого байта имени
файла. Но если на диск записать новые файлы, то
содержимое кластеров удаленного файла будет
изменено и восстановление станет невозможным. </p>

<h3><font SIZE="4" COLOR="#008000">Время создания или изменения
файла</font></h3>

<p>Остановимся подробнее на полях времени и даты
создания или последней модификации файла. MS-DOS
обновляет содержимое этих полей после любой
операции, изменяющей содержимое файла - создания
файла, перезаписи содержимого файла, добавления
данных в файл или обновления содержимого файла.
После обновления файла MS-DOS устанавливает бит
архивации 5 байта атрибутов в 1. </p>

<p>Формат поля времени показан на рис. 2.4. </p>

<p align="center"><img src="04/IMG00007.GIF" alt="IMG00007.GIF (1847 bytes)" WIDTH="377"
HEIGHT="45"> </p>

<p align="center"><i>Рис. 2.4. Формат поля времени</i> </p>

<p>Старшие пять бит содержат значение часа
модификации файла, шесть бит с номерами 5 - 10
содержат значение минут модификации файла, и,
наконец, в младших 5 битах хранится значение
секунд, деленное на 2. Для того, чтобы время
обновления файла уместилось в шестнадцати битах,
пришлось пойти на снижение точности времени до
двух секунд. </p>

<h3><font SIZE="4" COLOR="#008000">Дата создания или изменения
файла</font></h3>

<p>Формат даты обновления файла напоминает формат
времени (рис. 2.5). </p>

<p align="center"><img src="04/IMG00008.GIF" alt="IMG00008.GIF (1734 bytes)" WIDTH="377"
HEIGHT="45"> </p>

<p align="center"><i>Рис. 2.5. Формат поля даты</i> </p>

<p>Для того чтобы получить значение года
обновления файла, необходимо прибавить к
величине, хранимой в старших семи битах, значение
1980. Поля месяца и дня каких-либо особенностей не
имеют, они полностью соответствуют календарной
дате. </p>

<h3><font SIZE="4" COLOR="#008000">Длина файла</font> </h3>

<p>Поле длины в дескрипторе содержит точную длину
файла в байтах. Для каталогов в поле длины
записано нулевое значение. Вы не можете работать
с каталогом средствами MS-DOS, как с обычным файлом.
Единственный способ прочитать каталог как файл -
использование таблицы FAT для определения цепочки
занимаемых каталогом кластеров и чтение
секторов, соответствующих этим кластерам при
помощи прерывания INT&nbsp;25h . </p>
</body>
</html>
