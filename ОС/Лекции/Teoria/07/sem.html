<HTML>
<HEAD>
<title>Семафоры</title>
</HEAD>
<body>
	<h1>Семафоры</h1>
	<ul>
		<li><a href="#allocation">Выделение и  освобождение</a></li>
		<li><a href="#wait">Ожидание  и перенос  операции</a></li>
		<li><a href="#debug">Отладка семафоров</a></li>
	</ul>
	<p>
		Семафоры  - счетчики, которые разрешают синхронизировать  множественные  потоки. 
		<span class="term">Linux</span> предлогает альтернативную реализацию семафоров,
		которые могут использоваться для синхронизации процессов (семафоры процессов или,
		иногда, <span class="term">System V</span> семафоры). Семафоры  процессов выделяются,
		используются,  и освобождаются как  и сегменты общей  памяти. Хотя одного семафора  
		достаточно для  любого использования,  семафоры процессов входят в наборы. Мы представляем 
		системные вызовы для семафоров процессов,  показывая, как имитировать простой двоичный
		семафор, используя их.
	</p>
	<a name="allocation"></a>
	<h2>Выделение и  освобождение</h2>
	<p>
		Вызовы <span class="func">semget</span> и <span class="func">semctl</span> выделяют и 
		освобождают семафоры,  аналогично  <span class="func">shmget</span> и <span class="func">
		shmctl</span> для общей памяти.  Вызовите <span class="func">semget</span> с ключом,
		определяющим  набор семафора, число семафоров в наборе,  и флажки прав доступа, как и
		для <span class="func">shmget</span>; возвращаемое значение - идентификатор  набора семафора. 
		Вы  можете получить  идентификатор существующего семафора, зная значение его ключа;
		в этом случае, число семафоров может быть нулевым.
	</p>
	<p>	
		Семафоры продолжают существовать даже после того,  как  все процессы, использующие
		их завершились. Последний процесс,  использующий  набор семафора, должен явно удалить его.
		Чтобы  это сделать, вызовите <span class="func"> semctl</span>   с идентификатором  семафора,
		числом семафоров в наборе,  <span class="term"> IPC_RMID</span> как третий  параметр,
		и любое значение <span class="term"> union semun </span> как четвертый параметр  
		(который  игнорируется). Эффективный  пользовательский идентификатор вызывающего 
		процесса должен соответствовать идентификатору  программы выделевшей семафор 
		(или  вызывающая программа должна быть запущена суперпользователем). 
		В отличие от сегментов общей памяти, удаление семафора  заставляет <span class="term"> Linux 
		</span> освобождать его немедленно. 
	</p>
	<p>       
		Листинг 5.2 демонстрирует функции выделения и освободения двоичного семафора.<br>
		Выделение и освобождение двоичного семафора.(<a href="sem_al.c">sem_al.c</a>)
	</p>
<pre>
	#include &lt;sys/ipc.h&gt;
	#include &lt;sys/sem.h&gt;
	#include &lt;sys/types.h&gt;
	/* Мы должны определить  union semun  самостоятельно.  */ 
	union semun {
		int val;
		struct semid_ds *buf;
		unsigned short int *array;
		struct seminfo *__buf;
	};
	/* Получить идентификатор двоичного семафора, выделяя его в случае  необходимости. */
	int binary_semaphore_allocation (key_t key, int sem_flags)
	{
		return semget (key, 1, sem_flags);
	}
	* Освобождаем двоичной семафор. Все пользователи должны закончить использование семафора 
		к этому моменту.  Возвращает -1 при ошибке. */ 
	int binary_semaphore_deallocate (int semid)
	{
		union semun ignored_argument;
		return semctl (semid, 1, IPC_RMID, ignored_argument);
	}
</pre>

	<a name="wait"></a>  
	<h2>Ожидание  и перенос  операции</h2>
	<p>
		Каждый семафор  имеет неотрицательное  значение и поддерживает задержку и перенос операции.
		Системный вызов <span class="func"> semop</span> осуществляет обе операции. 
		Его первый параметр определяет идентификатор набора семафора. Его второй параметр - 
		массив <span class="term"> struct sembuf </span>, определяющие операции, которые вы 
		хотите выполнить. Третий  параметр - длина этого массива.
	<ul>
		Поля <span class="term"> struct sembuf</span> перечислены здесь: 
		<li>	<span class="term"> sem_num </span> - номер  семафора  в наборе семафоров,
			на  котором операция  выполнена. 
		</li>
		<li>	<span class="term"> sem_op </span> - целое число, которое определяет операцию
			семафора. Если sem_op -  положительное число, то число добавляется к значению
			семафора немедленно. Если <span class="term"> sem_op </span> - отрицательное
			число, то абсолютное значение числа вычетается из значения семафора. Если это
			сделает знаечение семафора отрицательным, то вызов блокируется, пока значение
			семафора не станет таким же большим, как абсолютное значением <span class="term">
			sem_op </span> (потому что другие процессы могут его увеличивать). Если <span class="term">
			sem_op </span> нулевое, операция блокируется, пока значение семафора не станет
			нулевым.
		</li>
		<li>	<span class="term"> sem_flg </span> - значение флажка.  Определите <span class="term"> 
			IPC_NOWAIT</span>,  чтобы предотвратить блокировку операции; если операция заблокирована,
			вызов <span class="term"> semop </span> вместо этого завершится ошибкой. Если Вы 
			определите <span class="term"> SEM_UNDO </span> ,<span class="term"> Linux </span> 
			автоматически отменит операцию с семафором, когда процесс прекратится. 
		</li>
	</ul>
	<p>
		Листинг 5.4  демонстрирует ожидание и перенос операции для двоичного семафора.
		(<a href="sem_w.c">sem_w.c</a>)
	</p>
<pre>
	#include &lt;sys/types.h&gt;
	#include &lt;sys/ipc.h&gt;
	#include &lt;sys/sem.h&gt;
	/* обслужить двойной  семафор. блокировка, пока   значение  семафора  положительное, заетм  декремент на 1. */ 
	int binary_semaphore_wait (int semid)
	{
		struct sembuf operations[1];
		/* использовать первый  (и только) семафор. */ 
		operations[0].sem_num = 0;
		/*  декремент 1. */
		operations[0].sem_op = -1;
		/*  разрешается отмена операции*/
		operations[0].sem_flg = sem_undo;
		return semop (semid, operations, 1);
	}
	/* пост к двоичному  семафору: увеличиваем его значение на 1. это выполнится немедленно. */
	int binary_semaphore_post (int semid)
	{
		struct sembuf operations[1];
		/* используем  первый семафор. */
		operations[0].sem_num = 0;
		/* increment by 1. */
		/* приращение на 1. */
		operations[0].sem_op = 1;
		/*разрешаем отмену операции. */ 
		operations[0].sem_flg = sem_undo;
		return semop (semid, operations, 1);
	}
</pre>
	<p>
		Определение флажка <span class="term"> SEM_UNDO </span> разрешает работать с проблемой
		завершения процесса при выделении ему ресурсов через семафор. Когда процесс завершается,
		добровольно или непреднамеренно, значения семафора автоматически корректируются,
		чтобы "отменить" эффекты  процесса на семафор. Например, если процесс, который 
		уменьшил семафор, уничтожен, значение семафора увеличевается.
	</p>
	<a name="debug"></a>
	<h2>Отладка семафоров</h2>
	<p>
		Используйте команду <span class="term"> ipcs -s </span> , чтобы отобразить информацию 
		о существующих наборах семафоров.
	</p>
	<p>
		Используйте  команду <span class="term"> ipcrm sem </span> , чтобы удалить набор
		семафоров из командной строки. Например,  чтобы удалить набор семафора с 
		идентификатором  5790517, используйте следующую команду: 
	</p>
	<div class="code">
		% ipcrm sem 5790517
	</div>
</body>
